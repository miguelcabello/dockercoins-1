apiVersion: apps/v1
kind: Deployment
metadata:
  name: hasher-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hasher
      env: production
      tier: backend
  template:
    metadata:
      labels:
        app: hasher
        env: production
        tier: backend
    spec:
      imagePullSecrets:
        - name: docker-academiaonline
      containers:
        - 
          args:
            - hasher.rb
          command:
            - ruby
          image: academiaonline/dockercoins-hasher:0.1
          name: hasher-container
          ports:
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /src/hasher.rb
              name: hasher-volume
              readOnly: true
              subPath: hasher.rb
          workingDir: /src/
      volumes:
        -
          configMap:
            defaultMode: 0400
            items:
              -
                key: hasher.rb
                mode: 0400
                path: hasher.rb
            name: hasher-cm
          name: hasher-volume
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: rng-ds
spec:
  selector:
    matchLabels:
      app: rng
      env: production
      tier: backend
  template:
    metadata:
      labels:
        app: rng
        env: production
        tier: backend
    spec:
      imagePullSecrets:
        - name: docker-academiaonline
      containers:
        - 
          args:
            - rng.py
          command:
            - python
          image: academiaonline/dockercoins-rng:0.1
          name: rng-container
          ports:
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /src/rng.py
              name: rng-volume
              readOnly: true
              subPath: rng.py
          workingDir: /src/
      volumes:
        -
          configMap:
            defaultMode: 0400
            items:
              -
                key: rng.py
                mode: 0400
                path: rng.py
            name: rng-cm
          name: rng-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webui-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webui
      env: production
      tier: frontend
  template:
    metadata:
      labels:
        app: webui
        env: production
        tier: frontend
    spec:
      imagePullSecrets:
        - name: docker-academiaonline      
      containers:
        - 
          args:
            - webui.js
          command:
            - node
          image: academiaonline/dockercoins:2.4-webui
          name: webui-container
          ports:
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /app/webui.js
              name: webui-volume
              readOnly: true
              subPath: webui.js
          workingDir: /app/
      volumes:
        -
          configMap:
            defaultMode: 0400
            items:
              -
                key: webui.js
                mode: 0400
                path: webui.js
            name: webui-cm
          name: webui-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: worker
      env: production
      tier: backend
  template:
    metadata:
      labels:
        app: worker
        env: production
        tier: backend
    spec:
      imagePullSecrets:
        - name: docker-academiaonline
      containers:
        - 
          args:
            - worker.py
          command:
            - python
          image: academiaonline/dockercoins-worker:0.2
          name: worker-container
          ports:
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /src/worker.py
              name: worker-volume
              readOnly: true
              subPath: worker.py
          workingDir: /src/
      volumes:
        -
          configMap:
            defaultMode: 0400
            items:
              -
                key: worker.py
                mode: 0400
                path: worker.py
            name: worker-cm
          name: worker-volume
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-sts
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
      env: production
      tier: database
  template:
    metadata:
      labels:
        app: redis
        env: production
        tier: database
    spec:
      containers:
        - 
          args:
            - redis-server
          command:
            - docker-entrypoint.sh
          image: library/redis:latest
          name: redis-container
          ports:
            - 
              containerPort: 6379
              protocol: TCP
          volumeMounts:
            -
              mountPath: /data/
              name: redis-volume
              readOnly: false
          workingDir: /data/
  volumeClaimTemplates:
    - 
      metadata:
        name: redis-volume
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: gp2
        resources:
          requests:
            storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: redis
spec:
  ports:
    -
      port: 6379
      protocol: TCP
      targetPort: 6379
  selector:
    app: redis
    env: production
    tier: database
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: rng
spec:
  ports:
    -
      port: 80
      protocol: TCP
      targetPort: 8080
  selector:
    app: rng
    env: production
    tier: backend
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: hasher
spec:
  ports:
    -
      port: 80
      protocol: TCP
      targetPort: 8080
  selector:
    app: hasher
    env: production
    tier: backend
  type: ClusterIP  
